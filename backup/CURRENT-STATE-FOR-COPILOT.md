# CURRENT SUPABASE STATE - FOR COPILOT CONTEXT

> **Export Date:** 2025-11-20  
> **Project:** Connet - Project Partnership Network  
> **Database:** Supabase PostgreSQL

---

## üìä EXECUTIVE SUMMARY

- **Total Tables:** 5 (users, user_roles, channels, messages, role_permissions)
- **Total Enums:** 2 (app_role, app_permission)
- **Total RPC Functions:** 22
- **Total Triggers:** 3 (auto_assign_role_on_signup, handle_new_auth_user, update_updated_at_column)
- **RLS Enabled:** Yes (all tables)
- **Auth Provider:** Supabase Auth
- **No Email Verification:** Users auto-confirmed

---

## üóÑÔ∏è COMPLETE TABLE SCHEMAS

> **Source:** Extracted from db_clusteer.backup + starting_point.json API documentation

### 1. `users` Table

```sql
-- Core user profiles table (synced from auth.users)
CREATE TABLE public.users (
    id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    email text UNIQUE NOT NULL,
    username text UNIQUE,
    full_name text,
    avatar_url text,
    projects text[],  -- Array of project names
    status text DEFAULT 'OFFLINE',  -- 'ONLINE' | 'OFFLINE'
    is_active boolean DEFAULT true NOT NULL,
    
    -- Professional/Academic Profile Fields
    bio text,
    institution text,
    department text,
    title text,  -- Job title / Academic position
    orcid_id text,  -- ORCID researcher ID
    linkedin_url text,
    website_url text,
    expertise_areas text[],  -- Array of expertise keywords
    skills text[],  -- Array of skill keywords
    location text,  -- Geographic location
    available_for_collaboration boolean DEFAULT false,
    
    -- Timestamps
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);

-- Indexes
CREATE UNIQUE INDEX users_email_idx ON public.users(email);
CREATE UNIQUE INDEX users_username_idx ON public.users(username);
CREATE INDEX users_institution_idx ON public.users(institution);
CREATE INDEX users_is_active_idx ON public.users(is_active);

-- RLS Enabled: YES
-- Policies defined below
```

### 2. `user_roles` Table

```sql
-- User role assignments (many-to-many relationship)
CREATE TABLE public.user_roles (
    user_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    role app_role NOT NULL,  -- Enum: admin, moderator, student, researcher, professor, user
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    PRIMARY KEY (user_id, role)
);

-- Indexes
CREATE INDEX user_roles_user_id_idx ON public.user_roles(user_id);
CREATE INDEX user_roles_role_idx ON public.user_roles(role);

-- RLS Enabled: YES
-- Policies defined below
```

### 3. `channels` Table

```sql
-- Communication channels for messaging
CREATE TABLE public.channels (
    id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    slug text UNIQUE NOT NULL,  -- Channel identifier/name
    created_by uuid REFERENCES public.users(id) ON DELETE SET NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

-- Indexes
CREATE UNIQUE INDEX channels_slug_idx ON public.channels(slug);
CREATE INDEX channels_created_by_idx ON public.channels(created_by);

-- RLS Enabled: YES
-- Policies defined below
```

### 4. `messages` Table

```sql
-- Messages within channels
CREATE TABLE public.messages (
    id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    message text NOT NULL,
    user_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    channel_id bigint NOT NULL REFERENCES public.channels(id) ON DELETE CASCADE,
    inserted_at timestamp with time zone DEFAULT now() NOT NULL
);

-- Indexes
CREATE INDEX messages_channel_id_idx ON public.messages(channel_id);
CREATE INDEX messages_user_id_idx ON public.messages(user_id);
CREATE INDEX messages_inserted_at_idx ON public.messages(inserted_at DESC);

-- RLS Enabled: YES
-- Policies defined below
```

---

## üè∑Ô∏è ENUMS

### `app_role` Enum

```sql
-- Role types for user_roles table
CREATE TYPE app_role AS ENUM (
    'admin',        -- Full system access
    'moderator',    -- Content moderation access
    'student',      -- Student user (@ogrenci.karabuk.edu.tr)
    'researcher',   -- Researcher user (@karabuk.edu.tr)
    'professor',    -- Professor/academic user
    'user'          -- Default user role
);

-- Auto-assigned based on email domain:
-- @ogrenci.karabuk.edu.tr ‚Üí student
-- @karabuk.edu.tr ‚Üí researcher
-- @gmail.com, @outlook.com, etc. ‚Üí user
-- Manual override possible via admin functions
```

---

## üîó FOREIGN KEYS & RELATIONSHIPS

```sql
-- PASTE RESULTS FROM:
-- SELECT * FROM information_schema.table_constraints WHERE constraint_type = 'FOREIGN KEY';

users.id -> auth.users.id (CASCADE DELETE)
user_roles.user_id -> users.id (CASCADE DELETE)
channels.created_by -> users.id
messages.user_id -> users.id
messages.channel_id -> channels.id

-- [PASTE COMPLETE FK DEFINITIONS]
```

---

## üìá INDEXES

```sql
-- PASTE RESULTS FROM:
-- SELECT * FROM pg_indexes WHERE schemaname = 'public';

-- [LIST ALL INDEXES]
```

---

## üîí ROW LEVEL SECURITY (RLS) POLICIES

### `users` Table Policies

```sql
-- PASTE FROM SUPABASE DASHBOARD OR:
-- SELECT * FROM pg_policies WHERE tablename = 'users';

-- Example:
-- Policy: "Users can view all profiles"
-- Operation: SELECT
-- Using: true

-- Policy: "Users can update own profile"
-- Operation: UPDATE
-- Using: auth.uid() = id

-- [PASTE ALL ACTUAL POLICIES]
```

### `user_roles` Table Policies

```sql
-- [PASTE ALL POLICIES]
```

### `channels` Table Policies

```sql
-- [PASTE ALL POLICIES]
```

### `messages` Table Policies

```sql
-- [PASTE ALL POLICIES]
```

---

## ‚öôÔ∏è RPC FUNCTIONS (Complete Definitions)

### 1. `check_database_setup()`

```sql
-- PASTE COMPLETE FUNCTION DEFINITION:
-- SELECT pg_get_functiondef(oid) FROM pg_proc WHERE proname = 'check_database_setup';

CREATE OR REPLACE FUNCTION public.check_database_setup()
RETURNS jsonb
LANGUAGE plpgsql
AS $$
-- [PASTE COMPLETE FUNCTION CODE]
$$;
```

### 2. `test_email_domains()`

```sql
-- [PASTE COMPLETE FUNCTION CODE]
```

### 3. `sync_specific_auth_user(target_user_id uuid)` ‚≠ê

```sql
-- [PASTE COMPLETE FUNCTION CODE]
-- This is critical for understanding user creation flow
```

### 4. `admin_create_complete_user()` ‚≠ê‚≠ê‚≠ê

```sql
-- [PASTE COMPLETE FUNCTION CODE]
-- MOST IMPORTANT - shows role detection, user creation pattern
```

### 5. `update_professional_profile()`

```sql
-- [PASTE COMPLETE FUNCTION CODE]
```

### 6. `search_users_by_expertise(search_term text)`

```sql
-- [PASTE COMPLETE FUNCTION CODE]
```

### 7. [Any Other RPC Functions]

```sql
-- [PASTE ALL OTHER FUNCTIONS]
```

---

## üé¨ TRIGGERS

### 1. `handle_new_user` Trigger

```sql
-- PASTE TRIGGER DEFINITION:
-- SELECT * FROM information_schema.triggers WHERE trigger_name = 'handle_new_user';

CREATE TRIGGER handle_new_user
    AFTER INSERT ON auth.users
    FOR EACH ROW
    EXECUTE FUNCTION public.handle_new_user_trigger();
```

### Trigger Function: `handle_new_user_trigger()`

```sql
-- PASTE COMPLETE TRIGGER FUNCTION:
CREATE OR REPLACE FUNCTION public.handle_new_user_trigger()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
-- [PASTE COMPLETE CODE]
-- This shows how users are auto-created and roles assigned
$$;
```

---

## üåê EDGE FUNCTIONS

```
List all Edge Functions from Supabase Dashboard:
1. [Function Name] - [Description]
2. [Function Name] - [Description]

If any exist, paste their TypeScript code here.
```

---

## üì° REALTIME CONFIGURATION

```
Which tables have Realtime enabled?
- channels: [YES/NO]
- messages: [YES/NO]
- users: [YES/NO]
- user_roles: [YES/NO]
```

---

## üíæ STORAGE BUCKETS (if any)

```sql
-- PASTE RESULT FROM:
-- SELECT * FROM storage.buckets;

-- Example:
-- avatars (public: true, file_size_limit: 5MB)
-- project-files (public: false)
```

---

## üîë AUTH CONFIGURATION

```
- Email Verification: DISABLED (auto-confirmed)
- Password Requirements: [PASTE FROM SUPABASE SETTINGS]
- JWT Expiry: [TIME]
- Refresh Token Rotation: [YES/NO]

Role Assignment Logic:
- @ogrenci.karabuk.edu.tr ‚Üí student
- @karabuk.edu.tr ‚Üí researcher
- @gmail.com/@outlook.com ‚Üí user
- Manual override via admin_create_complete_user
```

---

## üìä CURRENT DATA OVERVIEW

```sql
-- PASTE RESULTS:
SELECT 
    'users' as table_name, COUNT(*) as row_count 
FROM users
UNION ALL
SELECT 'user_roles', COUNT(*) FROM user_roles
UNION ALL
SELECT 'channels', COUNT(*) FROM channels
UNION ALL
SELECT 'messages', COUNT(*) FROM messages;

-- Current counts:
-- users: [COUNT]
-- user_roles: [COUNT]
-- channels: [COUNT]
-- messages: [COUNT]
```

---

## üîÑ CURRENT USER FLOW

### Signup Flow:
1. User calls `POST /auth/v1/signup` with email/password
2. Supabase creates auth.users record (auto-confirmed, no email verification)
3. Trigger `handle_new_user` fires automatically
4. Trigger creates public.users record
5. Trigger detects email domain and assigns role to user_roles table
6. Fallback: If trigger fails, frontend calls `sync_specific_auth_user()`

### Admin User Creation:
1. Admin calls `admin_create_complete_user()` RPC
2. Function detects role from email (or uses provided role override)
3. Function checks for duplicates (prevents duplicate key errors)
4. Function creates both public.users and user_roles records atomically
5. Returns success/error with complete user object

---

## üìù NOTES & CONSTRAINTS

- All users must have entry in both `auth.users` AND `public.users`
- User roles are stored separately in `user_roles` table (many-to-many possible)
- Profile updates use direct PATCH or `update_professional_profile()` RPC
- No email verification requirement (development mode)
- Duplicate prevention handled at function level
- Cascade deletes: auth.users ‚Üí users ‚Üí user_roles

---

## üéØ API PATTERNS (from starting_point.json)

### Authentication:
- `POST /auth/v1/signup` - Create account
- `POST /auth/v1/token?grant_type=password` - Login
- `POST /auth/v1/logout` - Logout

### User Management:
- `GET /rest/v1/users?select=*,user_roles(role)` - Get users with roles
- `PATCH /rest/v1/users?id=eq.{id}` - Update profile
- `POST /rest/v1/rpc/admin_create_complete_user` - Admin create user

### Messaging:
- `GET /rest/v1/channels` - List channels
- `POST /rest/v1/channels` - Create channel
- `GET /rest/v1/messages?channel_id=eq.{id}` - Get messages
- `POST /rest/v1/messages` - Send message

---

## ‚úÖ EXPORT CHECKLIST

- [ ] Run all SQL queries from `current-supabase-state.sql`
- [ ] Export complete table schemas
- [ ] Export all RLS policies
- [ ] Export all RPC function definitions
- [ ] Export all trigger definitions
- [ ] List Edge Functions (if any)
- [ ] Check Realtime configuration
- [ ] Document auth flow
- [ ] List current data counts
- [ ] Review and verify all exports

---

**Once completed, this file is ready for GitHub Copilot's plan feature!**
